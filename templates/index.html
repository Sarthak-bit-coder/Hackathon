<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Neighborhood Watch</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* Basic optional styling */
    .container { max-width: 600px; margin: auto; padding: 20px; }
    input, select, textarea, button { width: 100%; padding: 10px; margin-bottom: 10px; }
    .report { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .error { color: red; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Neighborhood Watch</h1>

    <form id="reportForm">
      <select name="type" id="type" required>
        <option value="">Select Type</option>
        <option value="Safety Concern">Safety Concern</option>
        <option value="Lost Item">Lost Item</option>
        <option value="Suspicious Activity">Suspicious Activity</option>
      </select>

      <textarea name="description" id="description" placeholder="Describe the issue..." required></textarea>

      <input type="text" id="zip" name="zip" placeholder="Enter ZIP Code" required pattern="\d{5}" />

      <input type="email" id="email" name="email" placeholder="Enter your email" required />

      <button type="submit">Submit</button>
      <p class="error" id="formError"></p>
    </form>

    <hr />
    <h2>Reports</h2>

    <input type="text" id="zipFilter" placeholder="Filter by ZIP code" />
    <button onclick="loadReports()">Filter</button>

    <div id="reportList"></div>
  </div>

  <script>
    const reportForm = document.getElementById('reportForm');
    const reportList = document.getElementById('reportList');
    const zipFilter = document.getElementById('zipFilter');
    const formError = document.getElementById('formError');

    function loadReports() {
      const zip = zipFilter.value.trim();
      const url = zip ? `/api/reports?zip=${zip}` : '/api/reports';

      fetch(url)
        .then(res => res.json())
        .then(data => {
          reportList.innerHTML = '';
          if (data.length === 0) {
            reportList.innerHTML = '<p>No reports found for this ZIP code.</p>';
            return;
          }

          data.forEach(r => {
            const div = document.createElement('div');
            div.classList.add('report');
            div.innerHTML = `
              <strong>${r.type}</strong>
              <p>${r.description}</p>
              <small><strong>ZIP:</strong> ${r.zip} | <strong>Email:</strong> ${r.email}</small>
            `;
            reportList.appendChild(div);
          });
        });
    }

    reportForm.addEventListener('submit', e => {
      e.preventDefault();
      formError.textContent = ''; // Clear previous errors

      const type = document.getElementById('type').value;
      const description = document.getElementById('description').value;
      const zip = document.getElementById('zip').value.trim();
      const email = document.getElementById('email').value.trim();

      // Basic client-side validation (ZIP and email already have HTML5 constraints)
      if (!/^\d{5}$/.test(zip)) {
        formError.textContent = 'Invalid ZIP code.';
        return;
      }

      fetch('/api/reports', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type, description, zip, email })
      })
      .then(res => res.json().then(data => ({ status: res.status, data })))
      .then(({ status, data }) => {
        if (status !== 201) {
          formError.textContent = data.error || 'Submission failed.';
        } else {
          reportForm.reset();
          loadReports();
        }
      })
      .catch(() => {
        formError.textContent = 'An error occurred while submitting the report.';
      });
    });

    window.onload = loadReports;
  </script>
</body>
</html>